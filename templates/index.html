<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentação da API Achô</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Heroicons -->
    <script src="https://unpkg.com/@heroicons/react@2.0.18/24/solid"></script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-primary-50 font-[Inter]">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h1 class="ml-2 text-2xl font-bold text-gray-900">API Achô</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/logout" 
                       class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        Sair
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div x-data="tabsData" class="space-y-6">
            <!-- Navegação das tabs -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button @click="changeTab('overview')"
                            :class="{ 'border-primary-500 text-primary-600': activeTab === 'overview' }"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Visão Geral
                    </button>
                    <button @click="changeTab('dashboard')"
                            :class="{ 'border-primary-500 text-primary-600': activeTab === 'dashboard' }"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Dashboard
                    </button>
                    <button @click="changeTab('test-search')"
                            :class="{ 'border-primary-500 text-primary-600': activeTab === 'test-search' }"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Testar Busca
                    </button>
                    <button @click="changeTab('examples-by-category')"
                            :class="{ 'border-primary-500 text-primary-600': activeTab === 'examples-by-category' }"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Exemplos por Categoria
                    </button>
                    <button @click="changeTab('suggestions')"
                            :class="{ 'border-primary-500 text-primary-600': activeTab === 'suggestions' }"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Sugestões
                    </button>
                    <button @click="changeTab('database')"
                            :class="{ 'border-primary-500 text-primary-600': activeTab === 'database' }"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <span class="flex items-center">
                            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
                            </svg>
                            Banco de Dados
                        </span>
                    </button>
                    <button @click="changeTab('searches')"
                            :class="{ 'border-primary-500 text-primary-600': activeTab === 'searches' }"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Buscas
                    </button>
                    <button @click="changeTab('categories')"
                            :class="{ 'border-primary-500 text-primary-600': activeTab === 'categories' }"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Categorias
                    </button>
                </nav>
            </div>

            <!-- Conteúdo das tabs -->
            <div class="bg-white shadow rounded-lg p-6">
                <div x-show="activeTab === 'overview'" class="space-y-8">
                    <h2 class="text-2xl font-bold text-gray-900">Visão Geral</h2>
                    
                    <!-- Descrição -->
                    <div class="prose max-w-none">
                        <p class="text-gray-600">
                            Essa API foi desenvolvida para processar e recuperar métricas de similaridade textual de forma eficiente, 
                            utilizando aprendizado de máquina e embeddings. Além disso, ela é capaz de integrar-se a modelos 
                            generativos avançados, como o <span class="font-semibold">Gemini</span>.
                        </p>
                    </div>

                    <!-- Benefícios -->
                    <div class="bg-primary-50 rounded-lg p-6 border border-primary-200">
                        <h3 class="font-semibold text-primary-700 mb-4">Benefícios da integração com o Gemini:</h3>
                        <ul class="space-y-3 text-primary-600">
                            <li class="flex items-center">
                                <svg class="h-5 w-5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span>Garante alta precisão em cenários mais complexos</span>
                            </li>
                            <li class="flex items-center">
                                <svg class="h-5 w-5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span>Reduz a probabilidade de erros ao lidar com textos ambíguos</span>
                            </li>
                            <li class="flex items-center">
                                <svg class="h-5 w-5 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span>Oferece uma abordagem híbrida e eficiente</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Exemplo de Uso -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900">Exemplo de Uso</h3>
                        
                        <!-- Request -->
                        <div class="space-y-2">
                            <h4 class="text-sm font-medium text-gray-700">Request:</h4>
                            <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                                <pre class="text-green-400 text-sm">POST /search_text
Content-Type: application/json

{
    "query": "Preciso de um banho e tosa para meu cachorro"
}</pre>
                            </div>
                        </div>

                        <!-- Response -->
                        <div class="space-y-2">
                            <h4 class="text-sm font-medium text-gray-700">Response:</h4>
                            <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                                <pre class="text-green-400 text-sm">{
    "document": "Serviços para animais de estimação",
    "degree_of_certainty": 0.95,
    "id": "8"
}</pre>
                            </div>
                        </div>

                        <!-- Explicação -->
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">
                                        O grau de certeza (degree_of_certainty) varia de 0 a 1, onde valores mais próximos de 1 indicam maior confiança na classificação.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div x-show="activeTab === 'dashboard'">
                    <!-- Conteúdo do Dashboard -->
                    <h2 class="text-2xl font-bold text-gray-900">Dashboard de Pesquisas</h2>
                    
                    <!-- Cards de Métricas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden group hover:shadow-md transition-all duration-200">
                            <div class="p-6">
                                <div class="flex items-center">
                                    <div class="bg-primary-50 rounded-lg p-3">
                                        <svg class="h-6 w-6 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <h3 class="text-sm font-medium text-gray-500">Total de Pesquisas</h3>
                                        <p class="mt-2 text-3xl font-bold text-gray-900" id="totalSearches">0</p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="w-full bg-gray-100 rounded-full h-1">
                                        <div class="bg-primary-500 h-1 rounded-full group-hover:bg-primary-600 transition-all duration-200" style="width: 75%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden group hover:shadow-md transition-all duration-200">
                            <div class="p-6">
                                <div class="flex items-center">
                                    <div class="bg-primary-50 rounded-lg p-3">
                                        <svg class="h-6 w-6 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <h3 class="text-sm font-medium text-gray-500">Média de Certeza</h3>
                                        <p class="mt-2 text-3xl font-bold text-gray-900" id="avgCertainty">0%</p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="w-full bg-gray-100 rounded-full h-1">
                                        <div class="bg-primary-500 h-1 rounded-full group-hover:bg-primary-600 transition-all duration-200" style="width: 75%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden group hover:shadow-md transition-all duration-200">
                            <div class="p-6">
                                <div class="flex items-center">
                                    <div class="bg-primary-50 rounded-lg p-3">
                                        <svg class="h-6 w-6 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                        </svg>
                                    </div>
                                    <div class="ml-4">
                                        <h3 class="text-sm font-medium text-gray-500">Categorias Únicas</h3>
                                        <p class="mt-2 text-3xl font-bold text-gray-900" id="uniqueCategories">0</p>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <div class="w-full bg-gray-100 rounded-full h-1">
                                        <div class="bg-primary-500 h-1 rounded-full group-hover:bg-primary-600 transition-all duration-200" style="width: 75%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gráfico e Lista -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Top Categorias -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Top 10 Categorias</h3>
                            <div class="space-y-4" id="topCategories"></div>
                        </div>
                        
                        <!-- Pesquisas Recentes -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Pesquisas Recentes</h3>
                            <div class="space-y-4" id="recentSearches"></div>
                        </div>
                    </div>
                </div>
                <div x-show="activeTab === 'test-search'" class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-900">Testar Busca de Texto</h2>
                    
                    <!-- Formulário de Teste -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-6">
                            <form id="searchTestForm" class="space-y-4">
                                <div class="relative">
                                    <label for="searchQuery" class="block text-sm font-medium text-gray-700 mb-2">
                                        Digite o texto para busca
                                    </label>
                                    <div class="relative">
                                        <input type="text" 
                                               id="searchQuery" 
                                               class="block w-full pl-10 pr-4 py-3 border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all duration-200"
                                               placeholder="Ex: preciso de um banho e tosa para meu cachorro">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" 
                                        class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-gradient-to-r from-primary-600 to-primary-500 hover:from-primary-700 hover:to-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200 shadow-sm hover:shadow-md">
                                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                    Buscar
                                </button>
                            </form>

                            <!-- Loading State (novo posicionamento e estilo) -->
                            <div id="searchLoading" class="hidden">
                                <div class="mt-4 flex items-center justify-center p-4 bg-white/80 backdrop-blur-sm rounded-lg border border-gray-200">
                                    <div class="flex items-center space-x-3">
                                        <div class="relative">
                                            <div class="w-8 h-8">
                                                <div class="absolute top-0 left-0 w-full h-full">
                                                    <div class="w-8 h-8 rounded-full absolute border-4 border-solid border-gray-200"></div>
                                                    <div class="w-8 h-8 rounded-full animate-spin absolute border-4 border-solid border-primary-500 border-t-transparent shadow-sm"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex flex-col">
                                            <span class="text-sm font-medium text-gray-900">Processando busca</span>
                                            <span class="text-xs text-gray-500">Aguarde um momento...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Resultado da Busca -->
                            <div id="searchResult" class="mt-6 hidden">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Resultado</h3>
                                <div class="bg-white rounded-lg p-4 border border-gray-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm font-medium text-gray-700">Categoria:</span>
                                        <span id="resultCategory" class="text-sm font-semibold text-gray-900"></span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium text-gray-700">Grau de Certeza:</span>
                                        <span id="resultCertainty" class="px-2 py-1 text-xs font-medium rounded-full"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Histórico de Buscas -->
                            <div class="mt-8">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Histórico de Buscas</h3>
                                <div id="searchHistory" class="space-y-3">
                                    <!-- O histórico será inserido aqui dinamicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div x-show="activeTab === 'examples-by-category'" class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-900">Exemplos por Categoria</h2>
                    
                    <!-- Loading state -->
                    <div id="examplesLoading" class="hidden">
                        <div class="flex justify-center items-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                        </div>
                    </div>
                    
                    <!-- Container para os exemplos -->
                    <div id="examplesByCategory" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Os exemplos serão inseridos aqui -->
                    </div>
                </div>
                <div x-show="activeTab === 'suggestions'" class="space-y-8">
                    <h2 class="text-2xl font-bold text-gray-900">Sugestões de Categorias</h2>
                    
                    <!-- Formulário de Sugestão -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Nova Sugestão</h3>
                        <form id="suggestionForm" class="space-y-4">
                            <div>
                                <label for="suggestion" class="block text-sm font-medium text-gray-700">
                                    Nova Categoria
                                </label>
                                <input type="text" 
                                       id="suggestion" 
                                       class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
                                       placeholder="Ex: Itens para Camping e Lazer ao Ar Livre">
                            </div>
                            <button type="submit" 
                                    class="inline-flex justify-center items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Enviar Sugestão
                            </button>
                        </form>
                    </div>

                    <!-- Minhas Sugestões -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Sugestões Pendentes -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <div class="flex items-center space-x-2 mb-4">
                                <div class="w-2 h-2 bg-yellow-400 rounded-full"></div>
                                <h3 class="text-lg font-semibold text-gray-700">Pendentes</h3>
                            </div>
                            <div id="pendingSuggestions" class="space-y-4">
                                <!-- Sugestões pendentes serão inseridas aqui -->
                            </div>
                        </div>

                        <!-- Sugestões Aprovadas -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <div class="flex items-center space-x-2 mb-4">
                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                <h3 class="text-lg font-semibold text-gray-700">Aprovadas</h3>
                            </div>
                            <div id="approvedSuggestions" class="space-y-4">
                                <!-- Sugestões aprovadas serão inseridas aqui -->
                            </div>
                        </div>

                        <!-- Sugestões Rejeitadas -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <div class="flex items-center space-x-2 mb-4">
                                <div class="w-2 h-2 bg-red-400 rounded-full"></div>
                                <h3 class="text-lg font-semibold text-gray-700">Não Aceitas</h3>
                            </div>
                            <div id="rejectedSuggestions" class="space-y-4">
                                <!-- Sugestões rejeitadas serão inseridas aqui -->
                            </div>
                        </div>
                    </div>

                    <!-- Painel de Admin -->
                    <div id="adminPanel" class="hidden space-y-6 mt-8">
                        <h3 class="text-xl font-bold text-gray-900">Painel Administrativo</h3>
                        
                        <!-- Filtros -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <div class="flex flex-wrap gap-4">
                                <div class="flex-1">
                                    <label for="userFilter" class="block text-sm font-medium text-gray-700 mb-2">
                                        Filtrar por Usuário
                                    </label>
                                    <select id="userFilter" 
                                            class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                        <option value="">Todos os usuários</option>
                                        <!-- Usuários serão inseridos aqui -->
                                    </select>
                                </div>
                                <div class="flex-1">
                                    <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-2">
                                        Status
                                    </label>
                                    <select id="statusFilter" 
                                            class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                        <option value="">Todos os status</option>
                                        <option value="pending">Pendentes</option>
                                        <option value="approved">Aprovadas</option>
                                        <option value="rejected">Rejeitadas</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de Sugestões do Admin -->
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                            <div id="adminSuggestionsList" class="space-y-4">
                                <!-- Sugestões serão inseridas aqui -->
                            </div>
                        </div>
                    </div>
                </div>
                <div x-show="activeTab === 'database'" class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-900">Visualização do Banco de Dados</h2>
                    
                    <!-- Seletor de Tabelas -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                        <div class="flex items-center space-x-4">
                            <label for="tableSelect" class="block text-sm font-medium text-gray-700">
                                Selecione a Tabela:
                            </label>
                            <select id="tableSelect" 
                                    class="block w-64 rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                <option value="query_response">Histórico de Buscas</option>
                                <option value="users">Usuários</option>
                                <option value="suggestions">Sugestões</option>
                            </select>
                            <button onclick="loadTableData()" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
                                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                Atualizar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="tableLoading" class="hidden">
                        <div class="flex items-center justify-center p-4">
                            <div class="flex items-center space-x-3">
                                <div class="animate-spin rounded-full h-8 w-8 border-4 border-primary-500 border-t-transparent"></div>
                                <span class="text-sm text-gray-500">Carregando dados...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabela de Dados -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead id="tableHeader" class="bg-gray-50">
                                    <!-- Cabeçalhos serão inseridos aqui -->
                                </thead>
                                <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Dados serão inseridos aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div x-show="activeTab === 'searches'" class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-900">Gestão de Buscas</h2>
                    
                    <!-- Resumo Semanal -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex flex-wrap items-end gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Semana</label>
                                <select id="weekFilter" class="rounded-lg border-gray-300 focus:border-primary-500 focus:ring-primary-500 min-w-[180px]"></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Dia</label>
                                <input id="dateFilter" type="date" class="rounded-lg border-gray-300 focus:border-primary-500 focus:ring-primary-500 min-w-[180px]" />
                            </div>
                            <div class="ml-auto flex items-center gap-2">
                                <button id="refreshSearches" class="px-4 py-2 text-sm text-white bg-primary-600 rounded-lg hover:bg-primary-700">Atualizar</button>
                                <button id="downloadWeek" class="px-4 py-2 text-sm rounded-lg border bg-white hover:bg-gray-50">Baixar (semana)</button>
                                <button id="downloadAll" class="px-4 py-2 text-sm rounded-lg border bg-white hover:bg-gray-50">Baixar (completo)</button>
                                <button id="downloadDay" class="px-4 py-2 text-sm rounded-lg border bg-white hover:bg-gray-50">Baixar (dia)</button>
                            </div>
                        </div>
                        <div id="weeklySummary" class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                    </div>
                    
                    <!-- Status e Navegação de Correções -->
                    <div class="mt-4 border-t pt-4 space-y-3">
                        <div class="flex flex-wrap items-center gap-3">
                            <span class="text-sm text-gray-600">Status:</span>
                            <span id="dayStatusBadge" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700">—</span>
                            <span id="weekStatusBadge" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700">—</span>
                            <div class="ml-auto flex flex-wrap gap-2">
                                <button id="markDayComplete" class="hidden px-3 py-1.5 text-xs rounded-lg border bg-white hover:bg-gray-50">Marcar dia concluído</button>
                                <button id="unmarkDayComplete" class="hidden px-3 py-1.5 text-xs rounded-lg border bg-white hover:bg-gray-50">Desmarcar dia</button>
                                <button id="markWeekComplete" class="hidden px-3 py-1.5 text-xs rounded-lg border bg-white hover:bg-gray-50">Marcar semana concluída</button>
                                <button id="unmarkWeekComplete" class="hidden px-3 py-1.5 text-xs rounded-lg border bg-white hover:bg-gray-50">Desmarcar semana</button>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <span class="text-sm text-gray-600">Navegar dias:</span>
                            <button id="prevPendingDay" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Anterior pendente</button>
                            <button id="nextPendingDay" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Próximo pendente</button>
                            <button id="prevCompletedDay" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Anterior concluído</button>
                            <button id="nextCompletedDay" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Próximo concluído</button>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <span class="text-sm text-gray-600">Navegar semanas:</span>
                            <button id="prevPendingWeek" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Anterior pendente</button>
                            <button id="nextPendingWeek" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Próximo pendente</button>
                            <button id="prevCompletedWeek" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Anterior concluída</button>
                            <button id="nextCompletedWeek" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Próxima concluída</button>
                        </div>
                    </div>
                    
                    <!-- Lista de Buscas -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Consulta</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Certeza</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="searchesTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <div class="flex items-center justify-between px-4 py-3 bg-gray-50 border-t">
                            <div class="text-sm text-gray-600">
                                <span id="paginationInfo">0 - 0 de 0</span>
                            </div>
                            <div class="flex gap-2">
                                <button id="prevPage" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Anterior</button>
                                <button id="nextPage" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Próxima</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div x-show="activeTab === 'categories'" class="space-y-6">
                    <h2 class="text-2xl font-bold text-gray-900">Gerenciar Categorias</h2>
                    
                    <!-- Formulário: Criar nova categoria -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-6">
                            <form id="categoryCreateForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="catFamily" class="block text-sm font-medium text-gray-700 mb-1">
                                        Família
                                    </label>
                                    <input type="text" id="catFamily" class="w-full border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500" placeholder="Ex: Serviços" required>
                                </div>
                                <div>
                                    <label for="catLabel" class="block text-sm font-medium text-gray-700 mb-1">
                                        Label
                                    </label>
                                    <input type="text" id="catLabel" class="w-full border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500" placeholder="Ex: Banho e tosa" required>
                                </div>
                                <div>
                                    <label for="catDocument" class="block text-sm font-medium text-gray-700 mb-1">
                                        Document
                                    </label>
                                    <input type="text" id="catDocument" class="w-full border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary-500" placeholder="Ex: Serviços para animais de estimação" required>
                                </div>
                                <div class="md:col-span-3 flex justify-end">
                                    <button type="submit" class="inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg">
                                        Criar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Lista de Categorias -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-4 flex items-center justify-between">
                            <h3 class="text-lg font-medium text-gray-900">Categorias</h3>
                            <button id="refreshCategories" class="px-3 py-1.5 text-sm rounded-lg border bg-white hover:bg-gray-50">Atualizar</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Família</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Label</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Document</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="categoriesTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white mt-12 border-t border-gray-200">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-gray-500">
                &copy; 2024 API Achô. Todos os direitos reservados.
            </p>
        </div>
    </footer>

    <script>
        // Função para verificar autenticação
        async function checkAuth() {
            try {
                const response = await fetch('/api/check-auth', {
                    credentials: 'same-origin'
                });
                if (!response.ok) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Erro ao verificar autenticação:', error);
                window.location.href = '/login';
            }
        }

        // Verificar autenticação periodicamente
        setInterval(checkAuth, 60000); // Verifica a cada minuto

        // Função para carregar sugestões
        async function loadSuggestions() {
            try {
                const response = await fetch('/api/suggestions', {
                    credentials: 'same-origin'
                });
                const suggestions = await response.json();
                
                // Elementos do DOM
                const pendingDiv = document.getElementById('pendingSuggestions');
                const approvedDiv = document.getElementById('approvedSuggestions');
                const rejectedDiv = document.getElementById('rejectedSuggestions');
                const adminPanel = document.getElementById('adminPanel');
                const adminList = document.getElementById('adminSuggestionsList');
                const userFilter = document.getElementById('userFilter');
                const statusFilter = document.getElementById('statusFilter');
                
                // Limpar containers
                pendingDiv.innerHTML = '';
                approvedDiv.innerHTML = '';
                rejectedDiv.innerHTML = '';
                adminList.innerHTML = '';
                
                // Separar sugestões por status
                const userSuggestions = suggestions.filter(s => !s.user_email);
                const adminSuggestions = suggestions.filter(s => s.user_email);
                
                // Preencher sugestões do usuário
                userSuggestions.forEach(suggestion => {
                    const targetDiv = suggestion.status === 'pending' ? pendingDiv :
                                    suggestion.status === 'approved' ? approvedDiv :
                                    rejectedDiv;
                    
                    targetDiv.appendChild(createSuggestionElement(suggestion, false));
                });
                
                // Atualizar painel de admin
                if (adminSuggestions.length > 0) {
                    adminPanel.classList.remove('hidden');
                    
                    // Coletar usuários únicos para o filtro
                    const users = [...new Set(adminSuggestions.map(s => s.user_email))].sort();
                    userFilter.innerHTML = `
                        <option value="">Todos os usuários</option>
                        ${users.map(user => `<option value="${user}">${user}</option>`).join('')}
                    `;
                    
                    // Aplicar filtros atuais
                    const selectedUser = userFilter.value;
                    const selectedStatus = statusFilter.value;
                    
                    // Filtrar sugestões
                    let filteredSuggestions = [...adminSuggestions]; // Criar uma cópia do array
                    
                    // Aplicar filtro de usuário
                    if (selectedUser) {
                        console.log('Filtrando por usuário:', selectedUser);
                        filteredSuggestions = filteredSuggestions.filter(s => s.user_email === selectedUser);
                    }
                    
                    // Aplicar filtro de status
                    if (selectedStatus) {
                        console.log('Filtrando por status:', selectedStatus);
                        filteredSuggestions = filteredSuggestions.filter(s => s.status === selectedStatus);
                    }
                    
                    // Ordenar por data (mais recentes primeiro)
                    filteredSuggestions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    // Limpar painéis antes de adicionar as sugestões filtradas
                    pendingDiv.innerHTML = '';
                    approvedDiv.innerHTML = '';
                    rejectedDiv.innerHTML = '';
                    adminList.innerHTML = '';
                    
                    // Distribuir sugestões filtradas nos painéis apropriados
                    filteredSuggestions.forEach(suggestion => {
                        // Adicionar à lista principal de admin
                        adminList.appendChild(createSuggestionElement(suggestion, true));
                        
                        // Adicionar ao painel correspondente
                        const targetDiv = suggestion.status === 'pending' ? pendingDiv :
                                        suggestion.status === 'approved' ? approvedDiv :
                                        rejectedDiv;
                        
                        targetDiv.appendChild(createSuggestionElement(suggestion, true));
                    });
                    
                    // Mostrar mensagem quando não houver resultados
                    if (filteredSuggestions.length === 0) {
                        adminList.innerHTML = `
                            <div class="bg-gray-50 rounded-lg p-4 text-center">
                                <p class="text-gray-500">Nenhuma sugestão encontrada com os filtros selecionados.</p>
                            </div>
                        `;
                    }
                    
                } else {
                    adminPanel.classList.add('hidden');
                }
                
            } catch (error) {
                console.error('Erro ao carregar sugestões:', error);
                // Mostrar mensagem de erro
                const errorMessage = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-700">
                                    Erro ao carregar sugestões. Por favor, tente novamente.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                adminList.innerHTML = errorMessage;
            }
        }

        function createSuggestionElement(suggestion, isAdminView) {
            const div = document.createElement('div');
            div.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-all duration-200';
            
            const statusColors = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'approved': 'bg-green-100 text-green-800',
                'rejected': 'bg-red-100 text-red-800'
            };
            
            const statusLabels = {
                'pending': 'Pendente',
                'approved': 'Aprovada',
                'rejected': 'Rejeitada'
            };
            
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <p class="font-medium text-gray-900">${suggestion.category}</p>
                        ${isAdminView ? `
                            <p class="text-sm text-gray-500 mt-1">
                                <span class="inline-flex items-center">
                                    <svg class="h-4 w-4 text-gray-400 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    ${suggestion.user_email}
                                </span>
                            </p>
                        ` : ''}
                        <p class="text-sm text-gray-500 mt-1">
                            <span class="inline-flex items-center">
                                <svg class="h-4 w-4 text-gray-400 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                ${new Date(suggestion.created_at).toLocaleDateString()}
                            </span>
                        </p>
                    </div>
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[suggestion.status]}">
                        ${statusLabels[suggestion.status]}
                    </span>
                </div>
                ${suggestion.admin_response ? `
                    <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-700">
                            <span class="font-medium">Resposta:</span> 
                            ${suggestion.admin_response}
                        </p>
                    </div>
                ` : ''}
                ${isAdminView && suggestion.status === 'pending' ? `
                    <div class="mt-3 flex space-x-2">
                        <button onclick="respondToSuggestion(${suggestion.id}, 'approved')" 
                                class="flex-1 px-3 py-1.5 text-sm text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors duration-200">
                            Aprovar
                        </button>
                        <button onclick="respondToSuggestion(${suggestion.id}, 'rejected')"
                                class="flex-1 px-3 py-1.5 text-sm text-white bg-red-500 rounded-lg hover:bg-red-600 transition-colors duration-200">
                            Rejeitar
                        </button>
                    </div>
                ` : ''}
            `;
            
            return div;
        }

        async function respondToSuggestion(id, status) {
            const response = prompt('Digite sua resposta:');
            if (!response) return;
            
            try {
                await fetch(`/api/suggestions/${id}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        status,
                        admin_response: response
                    })
                });
                
                loadSuggestions();
            } catch (error) {
                console.error('Erro ao responder sugestão:', error);
            }
        }

        // Formulário de sugestão
        document.getElementById('suggestionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const suggestion = document.getElementById('suggestion').value;
            
            try {
                await fetch('/api/suggestions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        category: suggestion
                    })
                });
                
                document.getElementById('suggestion').value = '';
                loadSuggestions();
            } catch (error) {
                console.error('Erro ao enviar sugestão:', error);
            }
        });

        // Configuração do Alpine.js
        document.addEventListener('alpine:init', () => {
            Alpine.data('tabsData', () => ({
                activeTab: localStorage.getItem('activeTab') || 'overview',
                initialized: {},
                
                async init() {
                    // Carregar dados da tab inicial se necessário
                    if (!this.initialized[this.activeTab]) {
                        await this.loadTabContent(this.activeTab);
                    }
                },
                
                async changeTab(tabName) {
                    if (this.activeTab === tabName) return;
                    
                    this.activeTab = tabName;
                    localStorage.setItem('activeTab', tabName); // Persistir a tab selecionada
                    
                    if (!this.initialized[tabName]) {
                        await this.loadTabContent(tabName);
                    }
                },
                
                async loadTabContent(tabName) {
                    this.initialized[tabName] = true;
                    
                    try {
                        switch(tabName) {
                            case 'dashboard':
                                await loadDashboard();
                                break;
                            case 'examples-by-category':
                                await loadCategoryExamples();
                                break;
                            case 'database':
                                await loadTableData();
                                break;
                            case 'suggestions':
                                await loadSuggestions();
                                break;
                            case 'searches':
                                await loadSearchesTab();
                                break;
                            case 'categories':
                                await loadCategoriesTab();
                                break;
                        }
                    } catch (error) {
                        console.error(`Erro ao carregar conteúdo da tab ${tabName}:`, error);
                        this.initialized[tabName] = false; // Permitir nova tentativa em caso de erro
                    }
                }
            }));
        });

        // Funções de carregamento de dados
        async function loadDashboard() {
            try {
                const response = await fetch('/api/statistics', {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                
                // Atualizar elementos do dashboard
                document.getElementById('totalSearches').textContent = data.total_searches;
                document.getElementById('avgCertainty').textContent = `${(data.average_certainty * 100).toFixed(1)}%`;
                document.getElementById('uniqueCategories').textContent = data.top_categories.length;
                
                // Atualizar top categorias
                const topCategoriesDiv = document.getElementById('topCategories');
                if (!topCategoriesDiv) {
                    console.error("Container topCategories não encontrado!");
                    return;
                }
                
                topCategoriesDiv.innerHTML = data.top_categories.map(cat => `
                    <div class="flex items-center">
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">${cat.category}</span>
                                <span class="text-sm text-gray-500">${cat.count}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-primary-600 h-2 rounded-full" style="width: ${(cat.count / data.total_searches * 100)}%"></div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Atualizar pesquisas recentes
                const recentSearchesDiv = document.getElementById('recentSearches');
                if (!recentSearchesDiv) {
                    console.error("Container recentSearches não encontrado!");
                    return;
                }
                
                recentSearchesDiv.innerHTML = data.recent_searches.map(search => `
                    <div class="border-l-4 border-primary-500 pl-4 py-2">
                        <p class="text-sm font-medium text-gray-900">${search.query}</p>
                        <p class="text-sm text-gray-500">
                            ${search.category} 
                            <span class="ml-2 px-2 py-0.5 text-xs rounded-full ${
                                search.certainty >= 0.8 ? 'bg-green-100 text-green-800' :
                                search.certainty >= 0.6 ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                            }">
                                ${(search.certainty * 100).toFixed(1)}%
                            </span>
                        </p>
                        <p class="text-xs text-gray-400 mt-1">
                            ${new Date(search.created_at).toLocaleString()}
                        </p>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        async function loadCategoryExamples() {
            const container = document.getElementById('examplesByCategory');
            const loadingDiv = document.getElementById('examplesLoading');
            
            if (!container || !loadingDiv) return;
            
            try {
                loadingDiv.classList.remove('hidden');
                container.innerHTML = '';
                
                const response = await fetch('/api/examples', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar exemplos');
                }
                
                const data = await response.json();
                
                Object.entries(data).forEach(([category, examples]) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'bg-white p-6 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-all duration-200';
                    
                    categoryDiv.innerHTML = `
                        <div class="flex items-center space-x-2 mb-4">
                            <div class="w-2 h-2 bg-primary-500 rounded-full"></div>
                            <h3 class="text-lg font-medium text-gray-900">
                                ${category.charAt(0).toUpperCase() + category.slice(1)}
                            </h3>
                        </div>
                        <ul class="space-y-3">
                            ${examples.map(example => `
                                <li class="flex items-start group">
                                    <svg class="h-5 w-5 text-primary-500 mr-2 mt-0.5 transform group-hover:scale-110 transition-transform" 
                                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                    <span class="text-sm text-gray-600 group-hover:text-gray-900 transition-colors">
                                        ${example}
                                    </span>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                    
                    container.appendChild(categoryDiv);
                });
                
            } catch (error) {
                console.error('Erro ao carregar exemplos:', error);
                container.innerHTML = `
                    <div class="col-span-full">
                        <div class="bg-red-50 border-l-4 border-red-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-red-700">
                                        Erro ao carregar exemplos. Por favor, tente novamente mais tarde.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        // Atualize a função performSearch
        async function performSearch(query) {
            const loadingDiv = document.getElementById('searchLoading');
            const searchButton = document.querySelector('#searchTestForm button[type="submit"]');
            const resultDiv = document.getElementById('searchResult');
            const categorySpan = document.getElementById('resultCategory');
            const certaintySpan = document.getElementById('resultCertainty');
            
            try {
                // Mostrar loading e desabilitar botão
                loadingDiv.classList.remove('hidden');
                searchButton.disabled = true;
                searchButton.classList.add('opacity-50', 'cursor-not-allowed');
                resultDiv.classList.add('hidden');
                
                const response = await fetch('/search_text', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ query })
                });
                
                const data = await response.json();
                
                // Aguardar um mínimo de tempo para mostrar o loading (melhor UX)
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Mostrar resultado
                resultDiv.classList.remove('hidden');
                
                if (response.ok) {
                    categorySpan.textContent = data.document;
                    const certainty = (data.degree_of_certainty * 100).toFixed(1);
                    certaintySpan.textContent = `${certainty}%`;
                    
                    // Definir cor baseada no grau de certeza
                    if (data.degree_of_certainty >= 0.8) {
                        certaintySpan.className = 'px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800';
                    } else if (data.degree_of_certainty >= 0.6) {
                        certaintySpan.className = 'px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800';
                    } else {
                        certaintySpan.className = 'px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800';
                    }
                    
                    // Adicionar ao histórico
                    addToHistory(query, data);
                    
                    // Atualizar dashboard se necessário
                    if (document.querySelector('[x-show="activeTab === \'dashboard\'"]')) {
                        await loadDashboard();
                    }
                } else {
                    categorySpan.textContent = data.message || 'Erro na busca';
                    certaintySpan.textContent = 'N/A';
                    certaintySpan.className = 'px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800';
                }
            } catch (error) {
                console.error('Erro na busca:', error);
                resultDiv.classList.remove('hidden');
                categorySpan.textContent = 'Erro ao processar a busca';
                certaintySpan.textContent = 'Erro';
                certaintySpan.className = 'px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800';
            } finally {
                // Restaurar estado inicial
                loadingDiv.classList.add('hidden');
                searchButton.disabled = false;
                searchButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Adicione a função addToHistory
        function addToHistory(query, result) {
            const historyDiv = document.getElementById('searchHistory');
            const historyItem = document.createElement('div');
            historyItem.className = 'bg-white p-4 rounded-lg shadow-sm border border-gray-200';
            
            const certainty = result.degree_of_certainty ? 
                (result.degree_of_certainty * 100).toFixed(1) + '%' : 'N/A';
            const certaintyClass = result.degree_of_certainty >= 0.8 ? 
                'bg-green-100 text-green-800' :
                result.degree_of_certainty >= 0.6 ? 
                    'bg-yellow-100 text-yellow-800' : 
                    'bg-red-100 text-red-800';
            
            historyItem.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-gray-900">${query}</p>
                        <p class="text-sm text-gray-500">${result.document}</p>
                    </div>
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${certaintyClass}">${certainty}</span>
                </div>
            `;
            
            historyDiv.prepend(historyItem);
        }

        // Adicione a função loadCategoriesTab
        async function loadCategoriesTab() {
            try {
                // Carregar lista
                await refreshCategoriesList();
                // Bind do formulário apenas uma vez
                const form = document.getElementById('categoryCreateForm');
                if (form && !form.dataset.bound) {
                    form.addEventListener('submit', handleCreateCategory);
                    document.getElementById('refreshCategories').addEventListener('click', refreshCategoriesList);
                    form.dataset.bound = 'true';
                }
            } catch (e) {
                console.error('Erro ao carregar a aba de categorias:', e);
            }
        }

        // Adicione a função refreshCategoriesList
        async function refreshCategoriesList() {
            const tbody = document.getElementById('categoriesTableBody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-sm text-gray-500">Carregando...</td></tr>';
            try {
                const res = await fetch('/api/categories', { credentials: 'same-origin' });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erro ao listar categorias');
                if (!Array.isArray(data)) throw new Error('Resposta inesperada');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-sm text-gray-500">Nenhuma categoria encontrada.</td></tr>';
                    return;
                }
                tbody.innerHTML = data.map(cat => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${cat.family}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${cat.label}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${cat.document}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${cat.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 space-x-2">
                            <button class="px-3 py-1.5 text-xs rounded-lg border bg-white hover:bg-gray-50" onclick='editCategory(${JSON.stringify(cat)})'>Editar</button>
                            <button class="px-3 py-1.5 text-xs rounded-lg text-white bg-red-500 hover:bg-red-600" onclick='deleteCategory("${cat.id}")'>Excluir</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-sm text-red-600">${e.message}</td></tr>`;
            }
        }

        // Adicione a função handleCreateCategory
        async function handleCreateCategory(ev) {
            ev.preventDefault();
            const family = document.getElementById('catFamily').value.trim();
            const label = document.getElementById('catLabel').value.trim();
            const documentName = document.getElementById('catDocument').value.trim();
            if (!family || !label || !documentName) return;
            try {
                const res = await fetch('/api/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ family, label, document: documentName })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.error || 'Falha ao criar categoria');
                // Limpa formulário e atualiza
                ev.target.reset();
                await refreshCategoriesList();
                alert(`Categoria criada com sucesso (ID: ${data.id || '—'})`);
            } catch (e) {
                alert(e.message);
            }
        }

        // Adicione a função editCategory
        async function editCategory(cat) {
            try {
                const newFamily = prompt('Família:', cat.family);
                if (newFamily === null) return;
                const newLabel = prompt('Label:', cat.label);
                if (newLabel === null) return;
                const newDocument = prompt('Document:', cat.document);
                if (newDocument === null) return;
                const res = await fetch(`/api/categories/${encodeURIComponent(cat.id)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ family: newFamily.trim(), label: newLabel.trim(), document: newDocument.trim() })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.error || 'Falha ao editar categoria');
                await refreshCategoriesList();
                alert('Categoria atualizada com sucesso');
            } catch (e) {
                alert(e.message);
            }
        }

        // Adicione a função deleteCategory
        async function deleteCategory(id) {
            if (!confirm('Tem certeza que deseja excluir esta categoria?')) return;
            try {
                const res = await fetch(`/api/categories/${encodeURIComponent(id)}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(data.error || 'Falha ao excluir categoria');
                await refreshCategoriesList();
                alert('Categoria removida com sucesso');
            } catch (e) {
                alert(e.message);
            }
        }

        // ===== Buscas (gestão) =====
        let SEARCHES_STATE = { isAdmin: false, limit: 20, offset: 0, total: 0, yearWeek: '', dayDate: '', categories: [] };

        async function getAuthInfo() {
            try {
                const res = await fetch('/api/check-auth', { credentials: 'same-origin' });
                if (!res.ok) return { authenticated: false, is_admin: false };
                return await res.json();
            } catch { return { authenticated: false, is_admin: false }; }
        }

        async function loadWeeks() {
            const weekSelect = document.getElementById('weekFilter');
            weekSelect.innerHTML = '<option value="">Todas as semanas</option>';
            const res = await fetch('/api/searches/weekly', { credentials: 'same-origin' });
            const weeks = await res.json();
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.year_week; opt.textContent = `${w.year_week} (${w.count})`;
                weekSelect.appendChild(opt);
            });
        }

        async function fetchCategoriesOptions() {
            try {
                const res = await fetch('/get_all_texts', { credentials: 'same-origin' });
                const data = await res.json();
                // Flatten into [{label, id}]
                const options = [];
                Object.values(data).forEach(subs => {
                    subs.forEach(s => options.push({ label: s.document, id: String(s.id) }));
                });
                // Unique by id
                const uniq = new Map();
                options.forEach(o => { if (!uniq.has(o.id)) uniq.set(o.id, o); });
                SEARCHES_STATE.categories = Array.from(uniq.values()).sort((a,b)=>a.label.localeCompare(b.label));
            } catch {}
        }

        function renderCategoryCell(item) {
            const hasCorrection = item.corrected_category && item.corrected_category_id;
            const cat = hasCorrection ? item.corrected_category : item.category;
            const id = hasCorrection ? item.corrected_category_id : item.category_id;
            const badge = hasCorrection ? '<span class="ml-2 px-2 py-0.5 text-[10px] rounded bg-blue-100 text-blue-700">Corrigida</span>' : '';
            return `<div><div class="font-medium text-gray-900">${cat || '-'}</div><div class="text-xs text-gray-500">ID: ${id || '-'}</div>${badge}</div>`;
        }

        function renderRow(item) {
            const certainty = item.degree_of_certainty != null ? (item.degree_of_certainty * 100).toFixed(1) + '%' : 'N/A';
            const certaintyClass = item.degree_of_certainty >= 0.8 ? 'bg-green-100 text-green-800' : item.degree_of_certainty >= 0.6 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm text-gray-500">${new Date(item.created_at).toLocaleString()}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${item.query}</td>
                    <td class="px-6 py-4">${renderCategoryCell(item)}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${item.category_id || '-'}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${certaintyClass}">${certainty}</span></td>
                    <td class="px-6 py-4">
                        ${SEARCHES_STATE.isAdmin ? `<button class="text-primary-600 hover:text-primary-800" onclick="openCorrection(${item.id})">Corrigir</button>` : '<span class="text-gray-400 text-sm">-</span>'}
                    </td>
                </tr>
            `;
        }

        window.openCorrection = async function(id) {
            const item = CURRENT_ITEMS.find(i => i.id === id);
            if (!item) return;
            if (SEARCHES_STATE.categories.length === 0) await fetchCategoriesOptions();
            renderCorrectionModal(item);
        };

        let CURRENT_ITEMS = [];
        async function loadSearches() {
            const params = new URLSearchParams();
            params.set('limit', SEARCHES_STATE.limit);
            params.set('offset', SEARCHES_STATE.offset);
            if (SEARCHES_STATE.dayDate) {
                params.set('date', SEARCHES_STATE.dayDate);
            } else if (SEARCHES_STATE.yearWeek) {
                params.set('year_week', SEARCHES_STATE.yearWeek);
            }
            const res = await fetch(`/api/searches?${params.toString()}`, { credentials: 'same-origin' });
            const data = await res.json();
            SEARCHES_STATE.total = data.total;
            CURRENT_ITEMS = data.items || [];
            const tbody = document.getElementById('searchesTableBody');
            tbody.innerHTML = CURRENT_ITEMS.map(renderRow).join('');
            const start = Math.min(SEARCHES_STATE.total, SEARCHES_STATE.offset + 1);
            const end = Math.min(SEARCHES_STATE.total, SEARCHES_STATE.offset + CURRENT_ITEMS.length);
            document.getElementById('paginationInfo').textContent = `${start} - ${end} de ${SEARCHES_STATE.total}`;
        }

        async function loadSearchesTab() {
            const auth = await getAuthInfo();
            SEARCHES_STATE.isAdmin = !!auth.is_admin;
            await loadWeeks();
            await loadSearches();
            await refreshCorrectionStatus();
            // events
            document.getElementById('refreshSearches').onclick = () => loadSearches();
            document.getElementById('weekFilter').onchange = async (e) => { SEARCHES_STATE.yearWeek = e.target.value; SEARCHES_STATE.dayDate = ''; document.getElementById('dateFilter').value = ''; SEARCHES_STATE.offset = 0; await loadSearches(); await refreshCorrectionStatus(); };
            document.getElementById('dateFilter').onchange = async (e) => { SEARCHES_STATE.dayDate = e.target.value; SEARCHES_STATE.yearWeek = ''; document.getElementById('weekFilter').value=''; SEARCHES_STATE.offset = 0; await loadSearches(); await refreshCorrectionStatus(); };
            document.getElementById('prevPage').onclick = () => { SEARCHES_STATE.offset = Math.max(0, SEARCHES_STATE.offset - SEARCHES_STATE.limit); loadSearches(); };
            document.getElementById('nextPage').onclick = () => { if (SEARCHES_STATE.offset + SEARCHES_STATE.limit < SEARCHES_STATE.total) { SEARCHES_STATE.offset += SEARCHES_STATE.limit; loadSearches(); } };
            document.getElementById('downloadWeek').onclick = () => {
                const params = new URLSearchParams();
                if (SEARCHES_STATE.yearWeek) params.set('year_week', SEARCHES_STATE.yearWeek);
                const url = '/api/searches/export' + (params.toString() ? `?${params.toString()}` : '');
                window.location.href = url;
            };
            document.getElementById('downloadAll').onclick = () => {
                window.location.href = '/api/searches/export';
            };
            document.getElementById('downloadDay').onclick = () => {
                if (!SEARCHES_STATE.dayDate) { alert('Selecione um dia.'); return; }
                const params = new URLSearchParams();
                params.set('date', SEARCHES_STATE.dayDate);
                const url = '/api/searches/export' + `?${params.toString()}`;
                window.location.href = url;
            };

            // Botões de marcar/desmarcar
            document.getElementById('markDayComplete').onclick = () => markComplete('day', SEARCHES_STATE.dayDate);
            document.getElementById('unmarkDayComplete').onclick = () => unmarkComplete('day', SEARCHES_STATE.dayDate);
            document.getElementById('markWeekComplete').onclick = () => markComplete('week', SEARCHES_STATE.yearWeek);
            document.getElementById('unmarkWeekComplete').onclick = () => unmarkComplete('week', SEARCHES_STATE.yearWeek);
        }

        // Modal para correção de categoria
        function renderCorrectionModal(item) {
            // Remover modal antigo se existir
            const existing = document.getElementById('correctionModal');
            if (existing) existing.remove();

            const selectedId = item.corrected_category_id || item.category_id || '';

            const modal = document.createElement('div');
            modal.id = 'correctionModal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50';
            modal.innerHTML = `
              <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4" role="dialog" aria-modal="true">
                <div class="px-6 py-4 border-b">
                  <h3 class="text-lg font-semibold text-gray-900">Corrigir Categoria</h3>
                  <p class="mt-1 text-sm text-gray-500">Query: <span class="font-medium text-gray-700">${item.query}</span></p>
                </div>
                <div class="p-6 space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Selecione a categoria correta</label>
                    <select id="correctionSelect" class="block w-full rounded-lg border-gray-300 focus:border-primary-500 focus:ring-primary-500">
                      ${SEARCHES_STATE.categories.map(c => `<option value="${c.id}" ${String(c.id)===String(selectedId)?'selected':''}>${c.label} (ID: ${c.id})</option>`).join('')}
                    </select>
                  </div>
                  <div class="text-sm text-gray-500">
                    Categoria atual: <span class="font-medium">${item.category || '-'}</span> (ID: ${item.category_id || '-'})
                  </div>
                </div>
                <div class="px-6 py-4 bg-gray-50 border-t flex justify-end gap-2">
                  <button id="cancelCorrection" class="px-4 py-2 text-sm rounded-lg border bg-white hover:bg-gray-50">Cancelar</button>
                  <button id="saveCorrection" class="px-4 py-2 text-sm text-white bg-primary-600 rounded-lg hover:bg-primary-700">Salvar</button>
                </div>
              </div>`;

            document.body.appendChild(modal);

            function closeModal() { modal.remove(); }

            modal.addEventListener('click', (e) => {
              if (e.target === modal) closeModal();
            });
            document.getElementById('cancelCorrection').onclick = closeModal;

            document.getElementById('saveCorrection').onclick = async () => {
              const select = document.getElementById('correctionSelect');
              const corrected_category_id = select.value;
              const corrected_category = select.options[select.selectedIndex]?.textContent?.replace(/\s*\(ID:.*\)$/, '') || '';

              try {
                const res = await fetch(`/api/searches/${item.id}/category`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'same-origin',
                  body: JSON.stringify({
                    corrected_category,
                    corrected_category_id
                  })
                });
                if (!res.ok) {
                  const t = await res.text().catch(()=> '');
                  throw new Error(t || 'Erro ao salvar correção');
                }
                closeModal();
                await loadSearches();
              } catch (err) {
                alert('Falha ao salvar correção: ' + err.message);
              }
            };

            // Fechar com ESC
            document.addEventListener('keydown', function onKey(e){
              if (e.key === 'Escape') { closeModal(); document.removeEventListener('keydown', onKey); }
            });
        }

        async function refreshCorrectionStatus() {
            try {
                const params = new URLSearchParams();
                if (SEARCHES_STATE.dayDate) params.set('date', SEARCHES_STATE.dayDate);
                if (SEARCHES_STATE.yearWeek) params.set('year_week', SEARCHES_STATE.yearWeek);
                const res = await fetch(`/api/searches/corrections/status?${params.toString()}`, { credentials: 'same-origin' });
                const data = await res.json();
                const dayBadge = document.getElementById('dayStatusBadge');
                const weekBadge = document.getElementById('weekStatusBadge');
                // Dia
                if (!SEARCHES_STATE.dayDate) {
                    dayBadge.textContent = '—';
                    dayBadge.className = 'px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700';
                } else if (data.day === true) {
                    dayBadge.textContent = 'Concluído';
                    dayBadge.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-800';
                } else {
                    dayBadge.textContent = 'Pendente';
                    dayBadge.className = 'px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800';
                }
                
                // Semana
                if (!SEARCHES_STATE.yearWeek) {
                    weekBadge.textContent = '—';
                    weekBadge.className = 'px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700';
                } else if (data.week === true) {
                    weekBadge.textContent = 'Concluída';
                    weekBadge.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-800';
                } else {
                    weekBadge.textContent = 'Pendente';
                    weekBadge.className = 'px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800';
                }
                updateCorrectionButtonsVisibility();
            } catch (e) {
                console.error('Falha ao carregar status de correções', e);
            }
        }

        function updateCorrectionButtonsVisibility() {
            const isAdmin = SEARCHES_STATE.isAdmin;
            const day = SEARCHES_STATE.dayDate;
            const week = SEARCHES_STATE.yearWeek;
            const dayBadge = document.getElementById('dayStatusBadge');
            const weekBadge = document.getElementById('weekStatusBadge');
            const markDay = document.getElementById('markDayComplete');
            const unmarkDay = document.getElementById('unmarkDayComplete');
            const markWeek = document.getElementById('markWeekComplete');
            const unmarkWeek = document.getElementById('unmarkWeekComplete');

            // Mostrar botões apenas para admin
            if (isAdmin && day) {
                markDay.classList.remove('hidden');
                unmarkDay.classList.remove('hidden');
            } else {
                markDay.classList.add('hidden');
                unmarkDay.classList.add('hidden');
            }
            if (isAdmin && week) {
                markWeek.classList.remove('hidden');
                unmarkWeek.classList.remove('hidden');
            } else {
                markWeek.classList.add('hidden');
                unmarkWeek.classList.add('hidden');
            }
        }

        async function markComplete(type, key) {
            if (!key) { alert('Seleção vazia.'); return; }
            try {
                const res = await fetch('/api/searches/corrections/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ type, key })
                });
                if (!res.ok) throw new Error(await res.text());
                await refreshCorrectionStatus();
            } catch (e) {
                alert('Falha ao marcar como concluído: ' + e.message);
            }
        }

        async function unmarkComplete(type, key) {
            if (!key) { alert('Seleção vazia.'); return; }
            try {
                const res = await fetch('/api/searches/corrections/uncomplete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ type, key })
                });
                if (!res.ok) throw new Error(await res.text());
                await refreshCorrectionStatus();
            } catch (e) {
                alert('Falha ao desmarcar: ' + e.message);
            }
        }

        // ===== Helpers de navegação (dias/semanas pendentes/concluídos) =====
        async function getCompletedSet(type) {
            try {
                const res = await fetch(`/api/searches/corrections/list?type=${type}`, { credentials: 'same-origin' });
                const data = await res.json();
                return new Set(data.keys || []);
            } catch { return new Set(); }
        }

        async function getDailyList(yearWeek) {
            try {
                const url = yearWeek ? `/api/searches/daily?year_week=${encodeURIComponent(yearWeek)}` : '/api/searches/daily';
                const res = await fetch(url, { credentials: 'same-origin' });
                const rows = await res.json();
                return rows.map(r => r.day);
            } catch { return []; }
        }

        function findNext(current, items, dir, filterSet, wantCompleted) {
            if (!items || items.length === 0) return null;
            const idx = current ? items.indexOf(current) : -1;
            let i = idx;
            for (let step = 0; step < items.length; step++) {
                i = (i + dir + items.length) % items.length;
                const key = items[i];
                const isCompleted = filterSet.has(key);
                if ((wantCompleted && isCompleted) || (!wantCompleted && !isCompleted)) return key;
            }
            return null;
        }

        async function gotoNextPrevDay(wantCompleted, dir) {
            const yearWeek = SEARCHES_STATE.yearWeek || '';
            const days = await getDailyList(yearWeek);
            if (days.length === 0) { alert('Sem dias disponíveis para navegar.'); return; }
            const completed = await getCompletedSet('day');
            const next = findNext(SEARCHES_STATE.dayDate || days[0], days, dir, completed, wantCompleted);
            if (!next) { alert('Nenhum dia encontrado.'); return; }
            SEARCHES_STATE.dayDate = next;
            document.getElementById('dateFilter').value = next;
            // Limpar semana se escolher dia específico
            SEARCHES_STATE.yearWeek = '';
            document.getElementById('weekFilter').value = '';
            SEARCHES_STATE.offset = 0;
            await loadSearches();
            await refreshCorrectionStatus();
        }

        async function gotoNextPrevWeek(wantCompleted, dir) {
            // lista de semanas vem do select weekFilter
            const weekSelect = document.getElementById('weekFilter');
            const weeks = Array.from(weekSelect.options).map(o => o.value).filter(Boolean);
            if (weeks.length === 0) { alert('Sem semanas disponíveis para navegar.'); return; }
            const completed = await getCompletedSet('week');
            const current = SEARCHES_STATE.yearWeek || weeks[0];
            const next = findNext(current, weeks, dir, completed, wantCompleted);
            if (!next) { alert('Nenhuma semana encontrada.'); return; }
            SEARCHES_STATE.yearWeek = next;
            weekSelect.value = next;
            // limpar dia ao navegar por semana
            SEARCHES_STATE.dayDate = '';
            document.getElementById('dateFilter').value = '';
            SEARCHES_STATE.offset = 0;
            await loadSearches();
            await refreshCorrectionStatus();
        }

        // Navegação
        document.getElementById('prevPendingDay').onclick = () => gotoNextPrevDay(false, -1);
        document.getElementById('nextPendingDay').onclick = () => gotoNextPrevDay(false, 1);
        document.getElementById('prevCompletedDay').onclick = () => gotoNextPrevDay(true, -1);
        document.getElementById('nextCompletedDay').onclick = () => gotoNextPrevDay(true, 1);
        document.getElementById('prevPendingWeek').onclick = () => gotoNextPrevWeek(false, -1);
        document.getElementById('nextPendingWeek').onclick = () => gotoNextPrevWeek(false, 1);
        document.getElementById('prevCompletedWeek').onclick = () => gotoNextPrevWeek(true, -1);
        document.getElementById('nextCompletedWeek').onclick = () => gotoNextPrevWeek(true, 1);
    </script>
    <script>
        (function bindSearchForm(){
            const form = document.getElementById('searchTestForm');
            if (!form || form.dataset.bound) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('searchQuery');
                const query = (input?.value || '').trim();
                if (!query) { 
                    input?.focus();
                    return; 
                }
                await performSearch(query);
            });
            form.dataset.bound = 'true';
        })();
    </script>
</body>
</html>
